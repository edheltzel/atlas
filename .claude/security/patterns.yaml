# =============================================================================
# Atlas Security Patterns Configuration
# =============================================================================
#
# This file defines security rules for the Atlas system to protect sensitive
# files, prevent dangerous operations, and maintain audit trails.
#
# Severity Levels:
#   BLOCK  - Immediately reject the operation, no exceptions
#   WARN   - Log the operation and prompt user for explicit confirmation
#   AUDIT  - Allow operation but log for review
#
# Pattern Syntax:
#   - Glob patterns: *, **, ?
#   - Home directory: ~ expands to user home
#   - Environment variables: $VAR or ${VAR}
#
# =============================================================================

version: "1.0"
metadata:
  name: "Atlas Security Patterns"
  description: "Security rules for protecting sensitive data and preventing dangerous operations"
  author: "Atlas System"
  updated: "2025-01-09"

# =============================================================================
# PROTECTED PATHS
# =============================================================================
# Filesystem locations containing sensitive data that require protection.
# Operations on these paths are subject to the specified severity level.

protected_paths:

  # ---------------------------------------------------------------------------
  # SSH Keys and Configuration
  # ---------------------------------------------------------------------------
  - path: "~/.ssh/*"
    description: "SSH private keys and configuration"
    severity: BLOCK
    operations: [read, write, delete, execute]
    reason: "SSH private keys must never be exposed or modified by automated tools"

  - path: "~/.ssh/config"
    description: "SSH client configuration"
    severity: WARN
    operations: [write, delete]
    reason: "SSH config changes could redirect connections to malicious hosts"

  # ---------------------------------------------------------------------------
  # GPG Keys and Keyring
  # ---------------------------------------------------------------------------
  - path: "~/.gnupg/*"
    description: "GPG keys and keyring data"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "GPG keys are used for encryption and code signing - must remain secure"

  - path: "~/.gnupg/pubring.kbx"
    description: "GPG public keyring"
    severity: WARN
    operations: [read]
    reason: "Public keys are less sensitive but still warrant caution"

  # ---------------------------------------------------------------------------
  # Cloud Provider Credentials
  # ---------------------------------------------------------------------------
  - path: "~/.aws/*"
    description: "AWS credentials and configuration"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "AWS credentials provide access to cloud infrastructure"

  - path: "~/.aws/config"
    description: "AWS CLI configuration (non-credential)"
    severity: WARN
    operations: [read, write]
    reason: "Config file may contain account IDs and region preferences"

  - path: "~/.config/gcloud/*"
    description: "Google Cloud credentials"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "GCP credentials provide access to cloud resources"

  - path: "~/.azure/*"
    description: "Azure CLI credentials"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Azure credentials provide access to cloud resources"

  # ---------------------------------------------------------------------------
  # API Tokens and CLI Credentials
  # ---------------------------------------------------------------------------
  - path: "~/.config/gh/*"
    description: "GitHub CLI authentication tokens"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "GitHub tokens provide repository and organization access"

  - path: "~/.netrc"
    description: "Network authentication credentials"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Contains plaintext credentials for various services"

  - path: "~/.npmrc"
    description: "NPM registry authentication"
    severity: WARN
    operations: [read, write]
    reason: "May contain registry tokens for private packages"

  - path: "~/.docker/config.json"
    description: "Docker registry credentials"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Contains authentication for container registries"

  # ---------------------------------------------------------------------------
  # Environment Files (Project-Level Secrets)
  # ---------------------------------------------------------------------------
  - path: "**/.env"
    description: "Environment variable files"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Environment files commonly contain API keys and secrets"

  - path: "**/.env.*"
    description: "Environment variant files (.env.local, .env.production, etc.)"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Environment variant files contain deployment-specific secrets"

  - path: "**/.env.example"
    description: "Environment example/template files"
    severity: AUDIT
    operations: [read]
    reason: "Example files typically contain placeholder values, safe to read"

  # ---------------------------------------------------------------------------
  # Claude/Atlas Configuration with Secrets
  # ---------------------------------------------------------------------------
  - path: "~/.claude/settings.json"
    description: "Claude Code settings (may contain API keys)"
    severity: WARN
    operations: [read, write]
    reason: "Settings may include sensitive configuration"

  - path: "~/.claude/credentials"
    description: "Claude authentication credentials"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Authentication tokens must remain secure"

  - path: "~/.dotfiles/atlas/.env"
    description: "Atlas environment configuration"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Contains API keys for Atlas integrations"

  - path: "**/atlas.local.yaml"
    description: "Local Atlas configuration with secrets"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Local config may contain override secrets"

  # ---------------------------------------------------------------------------
  # System Files
  # ---------------------------------------------------------------------------
  - path: "/etc/passwd"
    description: "System user database"
    severity: WARN
    operations: [read]
    reason: "User enumeration information"

  - path: "/etc/shadow"
    description: "System password hashes"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Password hashes must never be accessed"

  - path: "/etc/sudoers"
    description: "Sudo configuration"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Sudo config changes could enable privilege escalation"

  - path: "/etc/hosts"
    description: "Host resolution configuration"
    severity: WARN
    operations: [write, delete]
    reason: "Host file changes could redirect traffic"

  # ---------------------------------------------------------------------------
  # Database and Application Credentials
  # ---------------------------------------------------------------------------
  - path: "**/credentials.json"
    description: "Generic credentials files"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Credentials files contain authentication secrets"

  - path: "**/secrets.yaml"
    description: "Kubernetes/application secrets"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Secrets files contain sensitive configuration"

  - path: "**/secrets.json"
    description: "JSON secrets files"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Secrets files contain sensitive configuration"

  - path: "**/*.pem"
    description: "PEM certificate/key files"
    severity: WARN
    operations: [read, write, delete]
    reason: "PEM files may contain private keys"

  - path: "**/*.key"
    description: "Private key files"
    severity: BLOCK
    operations: [read, write, delete]
    reason: "Private key files must remain secure"

# =============================================================================
# DANGEROUS COMMAND PATTERNS
# =============================================================================
# Command patterns that should be blocked or warned about due to their
# potentially destructive nature.

dangerous_commands:

  # ---------------------------------------------------------------------------
  # Destructive File Operations
  # ---------------------------------------------------------------------------
  - pattern: "rm -rf /"
    description: "Recursive deletion of root filesystem"
    severity: BLOCK
    reason: "Would destroy entire system"
    variants:
      - "rm -rf /"
      - "rm -rf /*"
      - "rm -fr /"
      - "sudo rm -rf /"

  - pattern: "rm -rf ~"
    description: "Recursive deletion of home directory"
    severity: BLOCK
    reason: "Would destroy all user data"
    variants:
      - "rm -rf ~"
      - "rm -rf ~/*"
      - "rm -rf $HOME"
      - "rm -rf ${HOME}"
      - "rm -fr ~"

  - pattern: "rm -rf ."
    description: "Recursive deletion of current directory"
    severity: WARN
    reason: "Could accidentally delete project or important files"
    variants:
      - "rm -rf ."
      - "rm -rf ./*"
      - "rm -fr ."

  # ---------------------------------------------------------------------------
  # Disk and Filesystem Operations
  # ---------------------------------------------------------------------------
  - pattern: "mkfs"
    description: "Filesystem formatting commands"
    severity: BLOCK
    reason: "Would destroy all data on target device"
    variants:
      - "mkfs.*"
      - "mkfs.ext4"
      - "mkfs.xfs"
      - "mkfs.btrfs"

  - pattern: "dd .* of=/dev/"
    description: "Direct disk writes"
    severity: BLOCK
    reason: "Could overwrite disk contents or bootloader"
    variants:
      - "dd if=.* of=/dev/*"
      - "dd of=/dev/*"

  - pattern: "fdisk"
    description: "Partition table manipulation"
    severity: BLOCK
    reason: "Could destroy partition layout"
    variants:
      - "fdisk /dev/*"
      - "parted /dev/*"
      - "gdisk /dev/*"

  # ---------------------------------------------------------------------------
  # Permission Escalation
  # ---------------------------------------------------------------------------
  - pattern: "chmod 777"
    description: "World-writable permissions"
    severity: WARN
    reason: "Overly permissive, creates security vulnerabilities"
    exceptions:
      - "/tmp/*"
    variants:
      - "chmod 777 *"
      - "chmod -R 777 *"

  - pattern: "chmod 777 /etc"
    description: "World-writable system directories"
    severity: BLOCK
    reason: "Would compromise system security"
    variants:
      - "chmod 777 /etc/*"
      - "chmod -R 777 /etc"
      - "chmod 777 /usr/*"
      - "chmod -R 777 /var"

  - pattern: "chown root"
    description: "Changing ownership to root"
    severity: WARN
    reason: "Could lock out user access to files"
    variants:
      - "chown root:root *"
      - "chown -R root *"

  # ---------------------------------------------------------------------------
  # History and Audit Trail Manipulation
  # ---------------------------------------------------------------------------
  - pattern: "history -c"
    description: "Clear command history"
    severity: WARN
    reason: "Destroys audit trail of commands executed"
    variants:
      - "history -c"
      - "history --clear"

  - pattern: "unset HISTFILE"
    description: "Disable history logging"
    severity: WARN
    reason: "Prevents command logging for audit purposes"
    variants:
      - "unset HISTFILE"
      - "HISTFILE=/dev/null"
      - "HISTSIZE=0"

  - pattern: "shred.*history"
    description: "Secure deletion of history"
    severity: BLOCK
    reason: "Permanent destruction of audit trail"
    variants:
      - "shred ~/.bash_history"
      - "shred ~/.zsh_history"
      - "shred -u *history*"

  # ---------------------------------------------------------------------------
  # Network and Service Manipulation
  # ---------------------------------------------------------------------------
  - pattern: "iptables -F"
    description: "Flush all firewall rules"
    severity: BLOCK
    reason: "Would disable all network security rules"
    variants:
      - "iptables -F"
      - "iptables --flush"
      - "ufw disable"

  - pattern: "systemctl disable"
    description: "Disable system services"
    severity: WARN
    reason: "Could disable critical security services"
    variants:
      - "systemctl disable *"
      - "systemctl mask *"

  # ---------------------------------------------------------------------------
  # Git Dangerous Operations
  # ---------------------------------------------------------------------------
  - pattern: "git push.*--force.*main"
    description: "Force push to main/master branch"
    severity: WARN
    reason: "Could overwrite shared history and cause data loss"
    variants:
      - "git push --force origin main"
      - "git push -f origin main"
      - "git push --force origin master"
      - "git push --force-with-lease origin main"

  - pattern: "git reset --hard HEAD~"
    description: "Hard reset discarding commits"
    severity: WARN
    reason: "Permanently discards uncommitted changes and commits"
    variants:
      - "git reset --hard HEAD~*"
      - "git reset --hard origin/*"

  # ---------------------------------------------------------------------------
  # Credential Exposure
  # ---------------------------------------------------------------------------
  - pattern: "curl.*-u.*:.*@"
    description: "Credentials in curl command"
    severity: WARN
    reason: "Credentials may be logged or visible in process list"
    variants:
      - "curl -u user:pass*"
      - "curl --user *:*"
      - "wget --user=* --password=*"

  - pattern: "echo.*password"
    description: "Echoing passwords"
    severity: AUDIT
    reason: "Could expose credentials in logs or terminal"
    variants:
      - "echo *password*"
      - "echo *secret*"
      - "echo *token*"
      - "echo *api_key*"

# =============================================================================
# ALLOWED EXCEPTIONS
# =============================================================================
# Safe operations that are explicitly allowed on otherwise protected paths.
# These override the protected_paths rules for specific operations.

allowed_exceptions:

  # ---------------------------------------------------------------------------
  # SSH Public Keys (Read-Only)
  # ---------------------------------------------------------------------------
  - path: "~/.ssh/*.pub"
    description: "SSH public keys are safe to read and share"
    operations: [read]
    reason: "Public keys are designed to be shared"

  - path: "~/.ssh/known_hosts"
    description: "SSH known hosts file"
    operations: [read, write]
    reason: "Normal SSH operation requires updating known hosts"

  - path: "~/.ssh/authorized_keys"
    description: "Authorized keys for incoming connections"
    operations: [read]
    reason: "Reading authorized keys is safe"

  # ---------------------------------------------------------------------------
  # Git Operations in Project Directories
  # ---------------------------------------------------------------------------
  - path: "**/.git/*"
    description: "Git repository internals"
    operations: [read, write]
    reason: "Normal git operations require access to .git directory"
    conditions:
      - "within_project_directory"
      - "user_initiated"

  - path: "**/.gitignore"
    description: "Git ignore files"
    operations: [read, write]
    reason: "Git ignore files are non-sensitive configuration"

  - path: "**/.gitattributes"
    description: "Git attributes files"
    operations: [read, write]
    reason: "Git attributes are non-sensitive configuration"

  # ---------------------------------------------------------------------------
  # Directory Listing (Non-Content Access)
  # ---------------------------------------------------------------------------
  - path: "~/.ssh"
    description: "List SSH directory contents"
    operations: [list]
    reason: "Listing directory does not expose key contents"

  - path: "~/.aws"
    description: "List AWS directory contents"
    operations: [list]
    reason: "Listing directory does not expose credentials"

  - path: "~/.gnupg"
    description: "List GPG directory contents"
    operations: [list]
    reason: "Listing directory does not expose key contents"

  # ---------------------------------------------------------------------------
  # Configuration Reading (Non-Secret)
  # ---------------------------------------------------------------------------
  - path: "~/.aws/config"
    description: "AWS CLI configuration"
    operations: [read]
    reason: "Config file contains region/profile info, not credentials"
    conditions:
      - "credentials_not_embedded"

  - path: "~/.config/gh/hosts.yml"
    description: "GitHub CLI host configuration"
    operations: [read]
    reason: "Host config is safe if tokens are not embedded"
    conditions:
      - "tokens_not_embedded"

  # ---------------------------------------------------------------------------
  # Template and Example Files
  # ---------------------------------------------------------------------------
  - path: "**/.env.example"
    description: "Environment example files"
    operations: [read, write]
    reason: "Example files contain placeholder values only"

  - path: "**/.env.template"
    description: "Environment template files"
    operations: [read, write]
    reason: "Template files contain placeholder values only"

  - path: "**/.env.sample"
    description: "Environment sample files"
    operations: [read, write]
    reason: "Sample files contain placeholder values only"

  # ---------------------------------------------------------------------------
  # Project-Scoped Operations
  # ---------------------------------------------------------------------------
  - path: "${PROJECT_ROOT}/**"
    description: "Operations within current project"
    operations: [read, write, delete]
    reason: "Project files are the primary workspace"
    conditions:
      - "within_project_boundary"
      - "not_in_protected_subpath"

# =============================================================================
# AUDIT CONFIGURATION
# =============================================================================
# Settings for logging and monitoring security-relevant operations.

audit:
  # Enable audit logging
  enabled: true

  # Log file location
  log_path: "~/.dotfiles/atlas/logs/security-audit.log"

  # What to log
  log_events:
    - blocked_operations
    - warned_operations
    - exception_uses
    - pattern_matches

  # Log retention
  retention_days: 30
  max_size_mb: 100

  # Alert thresholds
  alerts:
    # Alert if more than N blocked operations in time window
    blocked_threshold: 5
    blocked_window_minutes: 10

    # Alert if same protected path accessed multiple times
    repeated_access_threshold: 3
    repeated_access_window_minutes: 5

# =============================================================================
# RUNTIME SETTINGS
# =============================================================================
# Configuration for how security rules are applied at runtime.

runtime:
  # Default severity for unmatched patterns
  default_severity: AUDIT

  # Whether to prompt on WARN severity (false = log only)
  interactive_warnings: true

  # Allow override via environment variable (for CI/CD)
  allow_env_override: false
  env_override_var: "ATLAS_SECURITY_OVERRIDE"

  # Bypass token for emergency access (hash of secret)
  # Set via: echo -n "secret" | sha256sum
  emergency_bypass_hash: null

  # Sandbox mode - block all protected path access
  sandbox_mode: false

  # Dry run mode - log but don't block anything
  dry_run: false
